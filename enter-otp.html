<!DOCTYPE html>
<html lang="en">
    <link>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Koyal - Music App</title>
    <link rel="stylesheet" href="./style.css"></link>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Intel -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css"
        integrity="sha512-DxV+EoADOkOygM4IR9yXP8Sb2qwgidEmeqAEmDKIOfPRQZOWbXCzLC6vjbZyy0vPisbH2SyW27+ddLVCN+OMzQ=="
        crossorigin="anonymous"
        referrerpolicy="no-referrer"
    >
    <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/fontawesome.min.css"
        integrity="sha512-J2Gce+WmOttffHOrVKLTlzxIalPXUMDbSfn5ADqp8Vj9EngnjNHr+jjiL3ZB8muEzo+K51gU10X+0eGqGNL7QA=="
        crossorigin="anonymous"
        referrerpolicy="no-referrer"
    >
</head>
<body>
    <div class="page">
        <div class=" mx-auto w-[max-content] lg:mb-0 mb-6 ">
            <img src="./koyal-logo.png">
        </div>
        <div class="container grid lg:grid-cols-2 grid-cols-1">
            <!-- Left Content -->
            <div class="left-content">
                <div class="tagline font-light mb-4">
                    Enter 4 Digit
                    <br>
                    <span class="text-[var(--primary-color)] font-bold">OTP</span>
                </div>
                <div class="flex flex-col  items-center lg:items-start">
                    <div class="flex gap-1 items-center mb-4  ">
                        <i id="edit-phone" class="fa-solid fa-pen-to-square text-[var(--primary-color)] text-[22px] cursor-pointer "></i>
                        <p id="show-number" class="text-white"></p>
                    </div>
                    <div class="flex  gap-3 mb-2 mt-2 ">
                        <input
                            type="text"
                            placeholder="_"
                            maxlength="1"
                            class="rounded-[15px] otp text-white bg-inherit w-14 h-14 text-center text-xl border border-gray-300 rounded focus:outline-none  focus:border-[var(--primary-color)]"
                        >
                        <input
                            type="text"
                            placeholder="_"
                            maxlength="1"
                            class="rounded-[15px] otp text-white w-14 h-14 bg-inherit text-center text-xl border border-gray-300 rounded focus:outline-none focus:border-[var(--primary-color)]"
                            pattern="^[0-9]+$"
                        >
                        <input
                            type="text"
                            placeholder="_"
                            maxlength="1"
                            class="rounded-[15px] otp text-white bg-inherit w-14 h-14 text-center text-xl border border-gray-300 rounded focus:outline-none focus:border-[var(--primary-color)]"
                            pattern="^[0-9]+$"
                        >
                        <input
                            type="text"
                            placeholder="_"
                            maxlength="1"
                            class="rounded-[15px] otp text-white bg-inherit w-14 h-14 text-center text-xl border border-gray-300 rounded focus:outline-none focus:border-[var(--primary-color)]"
                            pattern="^[0-9]+$"
                        >
                    </div>
                    <p class="text-[red] mb-2" id="input-error"></p>
                    <button class="subscribe-btn mt-2" id="continue">Continue</button>
                    <p class="text-white mt-4 ">
                        Didn't Receive a Code?
                        <button class="underline italic text-[var(--primary-color)] cursor-pointer" id="resend">Resend</button>
                    </p>
                </div>
            </div>
            <!-- Right Content - Phone Mockup -->
            <div class="flex justify-center items-center">
                <div class="phone-mockup  h-[375px] md:h-auto w-[max-content]  md:w-[fit-content]">
                    <img src="./mobile-Image.png">
                </div>
            </div>
        </div>
    </div>
</body>
<script>
    document.querySelector('#show-number').innerText = history?.state?.no
    const inputs = document.querySelectorAll(".otp");
    inputs.forEach((input, index) => {
        input.addEventListener("input", (e) => {
            e.target.value = e.target.value.replace(/[^0-9]/g, '')
            const val = e.target.value;
            if (val.length === 1 && index < inputs.length - 1) {
                inputs[index + 1].focus();
            }
        });
        input.addEventListener("keydown", (e) => {
            if (e.key === "Backspace" && !e.target.value && index > 0) {
                inputs[index - 1].focus();
            }
        });
    });
    const submitOtp=()=>{
 const otp = Array.from(inputs).map(input => input.value).join("");
        if (otp.length === 4) {
            document.getElementById('input-error').innerHTML=''

            verifyDetails(otp)
           
        } else {
            document.getElementById('input-error').innerHTML='Please enter otp'
        }
    }
    document.getElementById("continue").addEventListener("click", () =>submitOtp());
    function getDeviceInfo() {
        const userAgent = window.navigator.userAgent;
        const platform = window.navigator.platform;
        // Browser detection
        let browserName = "Unknown";
        if (/Chrome/.test(userAgent) && !/Edge|Edg|OPR/.test(userAgent)) {
            browserName = "Chrome";
        } else if (/Firefox/.test(userAgent)) {
            browserName = "Firefox";
        } else if (/Safari/.test(userAgent) && !/Chrome/.test(userAgent)) {
            browserName = "Safari";
        } else if (/Edg/.test(userAgent)) {
            browserName = "Edge";
        } else if (/OPR/.test(userAgent)) {
            browserName = "Opera";
        }
        // OS detection
        let osName = "Unknown";
        if (/Windows NT 10/.test(userAgent)) osName = "Windows 10";
        else if (/Windows NT 6.1/.test(userAgent)) osName = "Windows 7";
        else if (/Mac OS X/.test(userAgent)) osName = "macOS";
        else if (/Android/.test(userAgent)) osName = "Android";
        else if (/iPhone|iPad/.test(userAgent)) osName = "iOS";
        else if (/Linux/.test(platform)) osName = "Linux";
        // Device type
        const deviceType = /Mobi|Android/i.test(userAgent) ? "Mobile" : "Desktop";
        return {
            browser: browserName,
            operating_system: osName,
            device: deviceType,
        };
    }
    const info = getDeviceInfo();
    async function verifyDetails(otp) {
        const data = history?.state;
        const getDetails = await fetch(
            `https://pro.ip-api.com/json/?key=hhpkcv6Vl7kt8YW`
        );
        const location = await getDetails.json();
        console.log('loc', location)
        const baseUrl = `https://apiv2.koyal.pk/api/v2/web/subscriber/otp-verify`
        const res = await fetch(baseUrl, {
            method: 'POST',
            headers: { "content-type": 'application/json' },
            body: JSON.stringify({
                type: "MSISDN",
                value: data?.no,
                otp,
                profile_from: "WEB",
                profile_by: "MSISDN",
                msisdn_network: data?.operator?.toUpperCase(),
                device: info.device,
                browser: info.browser,
                operating_system: info.operating_system,
                ip_address: location?.query,
                city: location?.city,
                state: location?.regionName,
                country: location?.country,
                operator: data?.operator,
            })
        })
        const final = await res?.json()
        console.log('final', final?.response?.access_token)
        if(final?.response?.access_token){
        window.location.href = `https://koyal.pk?ref=${final?.response?.access_token}`;
        }else{
             document.getElementById('input-error').innerHTML='Please enter a valid OTP'
        }
    }
    document.getElementById('edit-phone').addEventListener('click', () => {
        const data = history?.state;
        // const nextUrl = window.location.href.replace('index', 'enter-otp');
        // Push state data
        // window.history.pushState({ no: `+92${sanitized}` }, '', nextUrl);
        // Navigate to next page
        // window.location.href = nextUrl;
        // history.back()
        // Fallback if no referrer or history
        const nextUrl = window.location.href.replace('enter-otp', 'enter-number');
        // Push state data
        window.history.replaceState({ no: data?.no, operator: data?.operator }, '', nextUrl);
    })
       async function resendOTP() {
          const data = history?.state;
        const baseUrl=`https://apiv2.koyal.pk/api/v2/web/subscriber/verify-details`
        const res=await fetch(baseUrl,{
            method:'POST',
            headers:{"content-type":"application/json"},
            body:JSON.stringify({
                  type: "MSISDN",
      value:data?.no ,
      operator:data?.operator,
      platformType: "web"
            })
        })
        const final=await res?.json()
        console.log('final', final)        
    }
    document.getElementById('resend').addEventListener('click', () => {
        resendOTP()
    })
</script>
</html>
