<!DOCTYPE html>
<html lang="en">
<link>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Koyal - Music App</title>
<link rel="stylesheet" href="./style.css">
</link>
<script src="https://cdn.tailwindcss.com"></script>
<!-- Intel -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link
    href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/all.min.css"
    integrity="sha512-DxV+EoADOkOygM4IR9yXP8Sb2qwgidEmeqAEmDKIOfPRQZOWbXCzLC6vjbZyy0vPisbH2SyW27+ddLVCN+OMzQ=="
    crossorigin="anonymous" referrerpolicy="no-referrer">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/7.0.0/css/fontawesome.min.css"
    integrity="sha512-J2Gce+WmOttffHOrVKLTlzxIalPXUMDbSfn5ADqp8Vj9EngnjNHr+jjiL3ZB8muEzo+K51gU10X+0eGqGNL7QA=="
    crossorigin="anonymous" referrerpolicy="no-referrer">
</head>

<body>
    <div class="page">
        <div class=" mx-auto w-[max-content] lg:mb-0 mb-6 ">
            <img src="./koyal-logo.png">
        </div>
        <div class="container grid lg:grid-cols-2 grid-cols-1">
            <!-- Left Content -->
            <div class="left-content">
                <div class="tagline font-light mb-4">
                    Enter 4 Digit
                    <br>
                    <span class="text-[var(--primary-color)] font-bold">OTP</span>
                </div>
                <div class="flex flex-col  items-center lg:items-start">
                    <div class="flex gap-1 items-center mb-4  ">
                        <i id="edit-phone"
                            class="fa-solid fa-pen-to-square text-[var(--primary-color)] text-[22px] cursor-pointer "></i>
                        <p id="show-number" class="text-white"></p>
                    </div>
                    <div class="flex  gap-3 mb-2 mt-2 ">
                        <input type="text" placeholder="_" maxlength="1"
                            class="rounded-[15px] otp text-white bg-inherit w-14 h-14 text-center text-xl border border-gray-300 rounded focus:outline-none  focus:border-[var(--primary-color)]">
                        <input type="text" placeholder="_" maxlength="1"
                            class="rounded-[15px] otp text-white w-14 h-14 bg-inherit text-center text-xl border border-gray-300 rounded focus:outline-none focus:border-[var(--primary-color)]"
                            pattern="^[0-9]+$">
                        <input type="text" placeholder="_" maxlength="1"
                            class="rounded-[15px] otp text-white bg-inherit w-14 h-14 text-center text-xl border border-gray-300 rounded focus:outline-none focus:border-[var(--primary-color)]"
                            pattern="^[0-9]+$">
                        <input type="text" placeholder="_" maxlength="1"
                            class="rounded-[15px] otp text-white bg-inherit w-14 h-14 text-center text-xl border border-gray-300 rounded focus:outline-none focus:border-[var(--primary-color)]"
                            pattern="^[0-9]+$">
                    </div>
                    <p class="text-[red] mb-2" id="input-error"></p>
                    <button class="subscribe-btn mt-2" id="continue">Continue</button>
                    <p class="text-white mt-4 ">
                        Didn't Receive a Code?
                        <button class="underline italic text-[var(--primary-color)] cursor-pointer"
                            id="resend">Resend</button>
                    </p>
                </div>
            </div>
            <!-- Right Content - Phone Mockup -->
            <div class="flex justify-center items-center">
                <div class="phone-mockup  h-[375px] md:h-auto w-[max-content]  md:w-[fit-content]">
                    <img src="./mobile-Image.png">
                </div>
            </div>
        </div>
    </div>
</body>
<script>
 document.getElementById('resend').disabled=true
   setTimeout(()=>{
             document.getElementById('resend').disabled=false
        },30000)
    const button=document.getElementById("continue")
    document.querySelector('#show-number').innerText = history?.state?.no
    const inputs = document.querySelectorAll(".otp");
    inputs.forEach((input, index) => {
        input.addEventListener("input", (e) => {
            e.target.value = e.target.value.replace(/[^0-9]/g, '')
            const val = e.target.value;
            if (val.length === 1 && index < inputs.length - 1) {
                inputs[index + 1].focus();
            }
        });
        input.addEventListener("keydown", (e) => {
            if (e.key === "Backspace" && !e.target.value && index > 0) {
                inputs[index - 1].focus();
            }
        });
    });

    const subscription = async (data) => {
        console.log('data', data, history.state)

        let res = null
        if (!data?.isSubscribe) {
            console.log('not subscribe')
            if (data?.operator == 'ufone') {
                res = await fetch(`https://ufoneapi.koyal.pk/api/ufone_api/generate_otp`, {
                    headers: {
                        "X-Client-Type": "web",
                        'content-type': 'application/json'
                    },
                    method: 'POST',
                    body: JSON.stringify({
                        MSISDN: data?.no?.includes("+") ? data?.no?.replace("+", "") : data?.no,
                        UserId: `${data?.user_id}`,
                    })
                });
                res = await res?.json()


            } else if (data?.operator == 'telenor') {
                // Payment URL
                let apiResponse = await fetch("https://apiv2.koyal.pk/api/v2/web/subscriber/payment-url-v2",

                    {
                        headers: {
                            Authorization: `Bearer ${data?.token}`,
                            'content-type': 'application/json'
                        },
                                                method:"POST",
                        body: JSON.stringify(
                            { msisdn: data?.no }
                        )
                    }
                );
                apiResponse = await apiResponse.json();
                console.log('apiResponse', apiResponse)

                //   Callback URL
                const body = {
                    action: "submit",
                    cid: apiResponse?.response?.cid,
                    token: apiResponse?.response?.token,
                };
                let apiCallBackV2 = await fetch("https://apiv2.koyal.pk/api/v2/web/subscriber/callback-v2",
                    {
                        headers: {
                            Authorization: `Bearer ${data?.token}`,
                            'content-type': 'application/json'

                        },
                                                method:"POST",
                        body: JSON.stringify(body)
                    }
                );
                apiCallBackV2 = await apiCallBackV2?.json()
                console.log('apiCallBackV2', apiCallBackV2)

                const final = await fetch(
                    `https://apiv2.koyal.pk/api/v2/web/subscriber/confirm_sub`,
                    
                    {
                        headers: {
                            Authorization: `Bearer ${data?.token}`,
                            'content-type': 'application/json'

                        },
                        method:"POST",
                        body:JSON.stringify({
                        cid: apiResponse?.response?.cid,
                        resp_code: apiCallBackV2?.response?.res_code,
                    })
                    }
                );
                res = await final?.join()

            } else if (data?.operator == 'zong') {

                const zongApi = await fetch(`https://zongapi.koyal.pk/api/zong/web/subscribe`, {
                    method: 'POST',
                    headers: { 'content-type': 'application/json' },
                    body: JSON.stringify({
                        msisdn: history?.state?.no,
                        bundle: 95006102,
                        channel: "web",
                    })
                });
                res = await zongApi?.json()
                console.log('res zong', res, zongApi)

            } else {

            }
        } else {
            res = { success: true }
        }
        console.log('res after', res)

        if ((res?.status && res?.status == "success") || res?.success) {
          
                button.disabled=false
                console.log('sub', data?.isSubscribe)
            if (data?.isSubscribe) {
                window.location.href = `http://localhost:3001?ref=${data?.token}`;
            } else {
                  const nextUrl = window.location.href.replace('enter-otp', 'thank-you');
              window.history.pushState({ token: data?.token }, '', nextUrl);
                window.location.href = nextUrl;

            }
        }

    }


    const submitOtp = () => {
        const otp = Array.from(inputs).map(input => input.value).join("");
        if (otp.length === 4) {
            document.getElementById('input-error').innerHTML = ''

            verifyDetails(otp)

        } else {
            document.getElementById('input-error').innerHTML = 'Please enter otp'
        }
    }
    button.addEventListener("click", () => submitOtp());
    function getDeviceInfo() {
        const userAgent = window.navigator.userAgent;
        const platform = window.navigator.platform;
        // Browser detection
        let browserName = "Unknown";
        if (/Chrome/.test(userAgent) && !/Edge|Edg|OPR/.test(userAgent)) {
            browserName = "Chrome";
        } else if (/Firefox/.test(userAgent)) {
            browserName = "Firefox";
        } else if (/Safari/.test(userAgent) && !/Chrome/.test(userAgent)) {
            browserName = "Safari";
        } else if (/Edg/.test(userAgent)) {
            browserName = "Edge";
        } else if (/OPR/.test(userAgent)) {
            browserName = "Opera";
        }
        // OS detection
        let osName = "Unknown";
        if (/Windows NT 10/.test(userAgent)) osName = "Windows 10";
        else if (/Windows NT 6.1/.test(userAgent)) osName = "Windows 7";
        else if (/Mac OS X/.test(userAgent)) osName = "macOS";
        else if (/Android/.test(userAgent)) osName = "Android";
        else if (/iPhone|iPad/.test(userAgent)) osName = "iOS";
        else if (/Linux/.test(platform)) osName = "Linux";
        // Device type
        const deviceType = /Mobi|Android/i.test(userAgent) ? "Mobile" : "Desktop";
        return {
            browser: browserName,
            operating_system: osName,
            device: deviceType,
        };
    }
    const info = getDeviceInfo();
    async function verifyDetails(otp) {
        button.disabled=true
        const data = history?.state;
        const getDetails = await fetch(
            `https://pro.ip-api.com/json/?key=hhpkcv6Vl7kt8YW`
        );
        const location = await getDetails.json();
        console.log('loc', location)
        const baseUrl = `https://apiv2.koyal.pk/api/v2/web/subscriber/otp-verify`
        const res = await fetch(baseUrl, {
            method: 'POST',
            headers: { "content-type": 'application/json' },
            body: JSON.stringify({
                type: "MSISDN",
                value: data?.no,
                otp,
                profile_from: "WEB",
                profile_by: "MSISDN",
                msisdn_network: data?.operator?.toUpperCase(),
                device: info.device,
                browser: info.browser,
                operating_system: info.operating_system,
                ip_address: location?.query,
                city: location?.city,
                state: location?.regionName,
                country: location?.country,
                operator: data?.operator,
            })
        })
        const final = await res?.json()
        console.log('final', final?.response)
        if (final?.response?.access_token) {

            subscription({
                token: final?.response?.access_token,
                user_id: final?.response?.data?.id,
                isSubscribe: final?.response?.subscriber?.status !== 'free',
                operator: history?.state?.operator,
                no: history?.state?.no

            })
        } else {
            document.getElementById('input-error').innerHTML = 'Please enter a valid OTP'
               button.disabled=false
        }
    }
    document.getElementById('edit-phone').addEventListener('click', () => {
        const data = history?.state;

        const nextUrl = window.location.href.replace('enter-otp', 'enter-number');
        window.history.replaceState({ no: data?.no, operator: data?.operator }, '', nextUrl);
    })
    async function resendOTP() {
        const data = history?.state;
        const baseUrl = `https://apiv2.koyal.pk/api/v2/web/subscriber/verify-details`
        const res = await fetch(baseUrl, {
            method: 'POST',
            headers: { "content-type": "application/json" },
            body: JSON.stringify({
                type: "MSISDN",
                value: data?.no,
                operator: data?.operator,
                platformType: "web"
            })
        })
        const final = await res?.json()
        console.log('final', final)
    }
    document.getElementById('resend').addEventListener('click', () => {
         document.getElementById('resend').disabled=true
        resendOTP()
        setTimeout(()=>{
             document.getElementById('resend').disabled=false
        },30000)
    })
</script>

</html>